// Simple persian date conversion functions
window.persianDate = function(unix) {
    const date = new Date(unix * 1000);
    const persian = gregorianToPersian(date.getFullYear(), date.getMonth() + 1, date.getDate());
    
    return {
        format: function(format) {
            return format
                .replace('YYYY', persian.year)
                .replace('MM', persian.month.toString().padStart(2, '0'))
                .replace('DD', persian.day.toString().padStart(2, '0'));
        },
        toCalendar: function(calendar) {
            if (calendar === 'gregorian') {
                return {
                    format: function(format) {
                        return format
                            .replace('YYYY', date.getFullYear())
                            .replace('MM', (date.getMonth() + 1).toString().padStart(2, '0'))
                            .replace('DD', date.getDate().toString().padStart(2, '0'));
                    }
                };
            }
            return this;
        }
    };
};

function gregorianToPersian(gy, gm, gd) {
    const g_d_m = [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334];
    
    let jy = gy <= 1600 ? 0 : 979;
    gy -= gy <= 1600 ? 621 : 1600;
    
    let gy2 = gm > 2 ? gy + 1 : gy;
    let days = (365 * gy) + Math.floor((gy2 + 3) / 4) + Math.floor((gy2 + 99) / 100) - 
               Math.floor((gy2 + 399) / 400) - 80 + gd + g_d_m[gm - 1];
    
    jy += 33 * Math.floor(days / 12053);
    days %= 12053;
    
    jy += 4 * Math.floor(days / 1461);
    days %= 1461;
    
    if (days >= 366) {
        jy += Math.floor((days - 1) / 365);
        days = (days - 1) % 365;
    }
    
    let jp = 0;
    for (let i = 0; i < 12 && days >= getDaysInPersianMonth(jy, i + 1); i++) {
        days -= getDaysInPersianMonth(jy, i + 1);
        jp++;
    }
    
    return {
        year: jy,
        month: jp + 1,
        day: days + 1
    };
}

function getDaysInPersianMonth(year, month) {
    if (month <= 6) return 31;
    if (month <= 11) return 30;
    return isPersianLeapYear(year) ? 30 : 29;
}

function isPersianLeapYear(year) {
    const breaks = [
        -61, 9, 38, 199, 426, 686, 756, 818, 1111, 1181, 1210,
        1635, 2060, 2097, 2192, 2262, 2324, 2394, 2456, 3178
    ];
    
    let leap = -14;
    let jp = breaks[0];
    
    for (let j = 1; j <= 19; j++) {
        let jm = breaks[j];
        let jump = jm - jp;
        if (year < jm) break;
        leap += Math.floor(jump / 33) * 8 + Math.floor((jump % 33) / 4);
        jp = jm;
    }
    
    let n = year - jp;
    if (n < jump) {
        leap += Math.floor(n / 33) * 8 + Math.floor((n % 33 + 3) / 4);
        if ((jump % 33) === 4 && (jump - n) === 4) leap++;
    }
    
    return (leap + 4) % 33 < 5;
} 