// Simple Persian Datepicker jQuery Plugin
(function($) {
    $.fn.persianDatepicker = function(options) {
        const defaults = {
            format: 'YYYY/MM/DD',
            autoClose: true,
            initialValue: false,
            initialValueType: 'persian',
            observer: true,
            calendar: {
                persian: {
                    locale: 'fa'
                }
            },
            onSelect: function() {}
        };
        
        const settings = $.extend({}, defaults, options);
        
        return this.each(function() {
            const $input = $(this);
            const input = this;
            
            // Store datepicker instance
            $input.data('datepicker', {
                show: function() {
                    // Simple implementation - just focus the input
                    input.focus();
                },
                hide: function() {
                    input.blur();
                }
            });
            
            // Handle input changes
            $input.on('change', function() {
                if (settings.onSelect) {
                    // Convert Persian date to Unix timestamp
                    const value = $input.val();
                    if (value) {
                        const parts = value.split('/');
                        if (parts.length === 3) {
                            const jy = parseInt(parts[0]);
                            const jm = parseInt(parts[1]);
                            const jd = parseInt(parts[2]);
                            
                            // Convert to Gregorian
                            const gregorian = persianToGregorian(jy, jm, jd);
                            const date = new Date(gregorian.year, gregorian.month - 1, gregorian.day);
                            const unix = Math.floor(date.getTime() / 1000);
                            
                            settings.onSelect(unix);
                        }
                    }
                }
            });
            
            // Simple validation
            $input.on('blur', function() {
                const value = $input.val();
                if (value && !isValidPersianDate(value)) {
                    $input.addClass('is-invalid');
                } else {
                    $input.removeClass('is-invalid');
                }
            });
        });
    };
    
    function isValidPersianDate(dateStr) {
        const parts = dateStr.split('/');
        if (parts.length !== 3) return false;
        
        const year = parseInt(parts[0]);
        const month = parseInt(parts[1]);
        const day = parseInt(parts[2]);
        
        if (isNaN(year) || isNaN(month) || isNaN(day)) return false;
        if (year < 1300 || year > 1500) return false;
        if (month < 1 || month > 12) return false;
        if (day < 1 || day > 31) return false;
        
        const maxDays = getDaysInPersianMonth(year, month);
        return day <= maxDays;
    }
    
    function persianToGregorian(jy, jm, jd) {
        let gy = jy <= 979 ? 621 : 1600;
        jy = jy <= 979 ? jy : jy - 979;
        
        let days = (365 * jy) + (Math.floor(jy / 33) * 8) + 
                  (Math.floor(((jy % 33) + 3) / 4)) + 78 + jd;
        
        if (jm < 7) {
            days += (jm - 1) * 31;
        } else {
            days += ((jm - 7) * 30) + 186;
        }
        
        let gy2 = gy + 1600;
        let gd = days - 79;
        
        let cycle = Math.floor(gd / 146097);
        gd = gd % 146097;
        
        let cyear = 0;
        if (gd >= 36525) {
            gd--;
            cyear = Math.floor(gd / 36524);
            if (cyear > 3) cyear = 3;
            gd -= cyear * 36524;
        }
        
        let year = Math.floor(gd / 365);
        if (year > 3) year = 3;
        
        gy = gy2 + (cycle * 400) + (cyear * 100) + year * 1;
        gd = gd - (year * 365);
        
        let leap = ((gy % 4 === 0 && gy % 100 !== 0) || (gy % 400 === 0)) ? 1 : 0;
        
        const sal_a = [0, 31, (59 + leap), (90 + leap), (120 + leap), (151 + leap),
                      (181 + leap), (212 + leap), (243 + leap), (273 + leap), 
                      (304 + leap), (334 + leap), (365 + leap)];
        
        let gm = 0;
        while (gm < 13 && gd >= sal_a[gm]) {
            gm++;
        }
        
        if (gm > 1) {
            gd = gd - sal_a[gm - 1];
        }
        
        return {
            year: gy,
            month: gm,
            day: gd + 1
        };
    }
    
    function getDaysInPersianMonth(year, month) {
        if (month <= 6) return 31;
        if (month <= 11) return 30;
        return isPersianLeapYear(year) ? 30 : 29;
    }
    
    function isPersianLeapYear(year) {
        const breaks = [
            -61, 9, 38, 199, 426, 686, 756, 818, 1111, 1181, 1210,
            1635, 2060, 2097, 2192, 2262, 2324, 2394, 2456, 3178
        ];
        
        let leap = -14;
        let jp = breaks[0];
        
        for (let j = 1; j <= 19; j++) {
            let jm = breaks[j];
            let jump = jm - jp;
            if (year < jm) break;
            leap += Math.floor(jump / 33) * 8 + Math.floor((jump % 33) / 4);
            jp = jm;
        }
        
        let n = year - jp;
        if (n < jump) {
            leap += Math.floor(n / 33) * 8 + Math.floor((n % 33 + 3) / 4);
            if ((jump % 33) === 4 && (jump - n) === 4) leap++;
        }
        
        return (leap + 4) % 33 < 5;
    }
})(jQuery); 